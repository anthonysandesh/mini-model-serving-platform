# Mini Model Serving Platform Architecture

```
                   +-----------------+
                   |   Developers    |
                   +--------+--------+
                            |
                   git push | (manifests)
                            v
                       +----+----+
                       | ArgoCD  |----> K8s cluster
                       +----+----+
                            |
+---------------------------+-------------------------------------------+
| Docker Compose (local) / Kubernetes                                   |
|                                                                       |
|  +-----------+      +-----------+      +-------------+                |
|  |  Triton   |<---->|  Gateway  |<---->| Feature API |                |
|  +-----------+  RPC +-----------+ REST +-------------+                |
|       ^                 |                     ^                       |
|       | metrics         | alerts/webhook      |                       |
|  +----+-----+           |                     |                       |
|  | Prometheus|<---------+---------------------+                       |
|  +----------+ \                                                     |
|      ^        \                                                     |
|      |         \                                                    |
|  +---+----+     +-----------+                                      |
|  |Grafana |<----| Alertmgr  |                                      |
|  +--------+     +-----------+                                      |
+---------------------------------------------------------------------+
```

## Components
- **Model registry**: filesystem/SQLite JSON registry with FastAPI surface.
- **Triton**: serves ONNX models from model repository generated by `build_example_model.py`.
- **Gateway**: FastAPI service that fetches features, calls Triton, emits metrics, and handles alert webhooks.
- **Feature API**: Serves features from Parquet store (Feast optional).
- **Monitoring**: Prometheus scrapes gateway/feature API/Triton; Grafana shows dashboards.
- **Canary + rollback**: Gateway traffic splitter with PromQL-based health checks and Alertmanager webhook rollback.
- **GitOps**: Kustomize bases + overlays with ArgoCD application manifest.

## Flows
- **Prediction**: Client -> Gateway `/predict` -> Feature API (if needed) -> Triton -> Gateway response; metrics + drift emitted.
- **Canary**: `mmsp deploy --canary 10` updates deployment state. Gateway randomly routes traffic to canary weight. `watch_canary` queries Prometheus and promotes or rolls back.
- **Alert-driven rollback**: Prometheus alerts -> Alertmanager -> Gateway `/alerts` -> rollback canary state.

## Storage
- Artifacts under `artifacts/` for registry, deployment state, and resolved configs.
- Feature store Parquet at `artifacts/features/store.parquet`.

## GitOps
- `k8s/base` defines services/deployments; overlays `dev` and `prod` adjust namespaces and images.
- `k8s/apps/argocd-application.yaml` points ArgoCD to sync overlays.
